"use strict";var y=Object.create;var S=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var O=(a,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of b(e))!D.call(a,s)&&s!==t&&S(a,s,{get:()=>e[s],enumerable:!(n=_(e,s))||n.enumerable});return a};var g=(a,e,t)=>(t=a!=null?y(A(a)):{},O(e||!a||!a.__esModule?S(t,"default",{value:a,enumerable:!0}):t,a));var C=require("discord.js");var d=g(require("dotenv"));d.default.config();var{DISCORD_TOKEN:f,SATISFACTORY_TOKEN:m,SATISFACTORY_API_BASE:p,DISCORD_CHANNEL_ID:u,UPDATE_FREQUENCY_SEC:h}=process.env;if(!f||!m||!p||!u||!h)throw new Error("Missing environment variables");var r={DISCORD_TOKEN:f,DISCORD_CHANNEL_ID:u,SATISFACTORY_TOKEN:m,SATISFACTORY_API_BASE:p,UPDATE_FREQUENCY_SEC:parseInt(h)};var o=require("zod"),I=o.z.object({numConnectedPlayers:o.z.number(),isGameRunning:o.z.boolean(),totalGameDuration:o.z.number(),isGamePaused:o.z.boolean(),techTier:o.z.number()}),R=o.z.object({data:o.z.object({serverGameState:I})}),c=class{constructor(){this.state={};this.callbacks={}}updateField(e,t){return this.state[e]===void 0?(this.state[e]=t,!1):t!==this.state[e]?(this.callbacks[e]&&this.callbacks[e](this.state[e],t),this.state[e]=t,!0):!1}async update(){process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";try{let e=await fetch(r.SATISFACTORY_API_BASE,{headers:{Authorization:`Bearer ${r.SATISFACTORY_TOKEN}`,"Content-Type":"application/json"},method:"POST",body:'{"function":"QueryServerState"}'}),t=R.parse(await e.json()).data.serverGameState;for(let[n,s]of Object.entries(t)){let T=n;this.updateField(T,s)}}catch(e){console.error(`Failed to update: ${e}`)}}},E=c;var l=new C.Client({intents:["Guilds","GuildMessages"]}),i=null;l.once("ready",()=>{let a=l.channels.cache.get(r.DISCORD_CHANNEL_ID);if(!a){console.error("Channel does not exist");return}i=new E,console.log("Bot is ready !");let e=t=>{t&&a.isSendable()&&(console.info(t),a.send(t))};i.callbacks.numConnectedPlayers=async(t,n)=>{n>t?e(`Someone joined the game! (Player count ${t}->${n})`):n<t&&e(`Someone left the game! (Player count ${t}->${n})`)},i.callbacks.isGamePaused=async(t,n)=>{e(n?"Server is now paused.":"Server is no longer paused.")},setInterval(()=>{i?.update()},r.UPDATE_FREQUENCY_SEC*1e3),i?.update()});l.login(r.DISCORD_TOKEN);
